name: deploy-k8s
on:
  push:
    branches: ["main"]

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: ap-south-1
  CLUSTER_NAME: simple-saas-devops-eks
  NAMESPACE: people

jobs:
  apply:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Update kubeconfig
        run: aws eks update-kubeconfig --region "$AWS_REGION" --name "$CLUSTER_NAME"

      - name: Apply kustomize base
        run: |
          kubectl apply -k base/
          kubectl -n "$NAMESPACE" rollout status deploy/mongo --timeout=300s || true
          kubectl -n "$NAMESPACE" rollout status deploy/people-api --timeout=300s || true

      - name: Health check (print LoadBalancer & /health)
        run: |
          set -e
          for i in {1..30}; do
            LB=$(kubectl -n "$NAMESPACE" get svc people-api -o jsonpath='{.status.loadBalancer.ingress[0].hostname}' 2>/dev/null || true)
            if [ -n "$LB" ]; then echo "LB=$LB"; break; fi
            sleep 10
          done
          test -n "$LB"
          curl -sSf "http://$LB/health" | tee /tmp/health.json
          echo "::notice title=health::$(cat /tmp/health.json)"
